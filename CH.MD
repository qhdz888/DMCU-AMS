# Babu-Bus
与 Babu 总线相关的工具和文档

## 简介
babu-bus 是一种专有协议，基于通过 RS485 总线的 UART 进行通信<br>
UART 的时钟频率为 1228800bps，具有 1 个偶校验位和 1 个停止位。

## 报头和设备寻址
babu 总线使用两种数据包格式：<br>
长报头数据包，其中包含指示多个可用设备之间主从关系的数据<br>
短报头数据包，用于在 1 个预设的主从设备之间进行通信。

这些数据包通常由一个起始字节 _3D_、一个数据包长度指示符和一个用于验证报头完整性的 8 位 CRC 组成。<br>

### 长报头

| 字节数 | 内容 | 占用字节数 |
|-------------|----------------------------------|----------------|
| 0 | 0x3D | 1 |
| 1 | 标志（小于 0x80）| 1 |
| 2~3 | 数据包序列 | 2 |
| 4~5 | 数据包总长度 L | 2 |
| 6 | 对所有先前字节进行 CRC8 校验 [1] | 1 |
| 7~8 | 目标地址 | 2 |
| 9~10 | 源地址 | 2 |
| 11~(L-3) | 数据包内容 | L-13 |
| (L-2)~(L-1) | 对所有先前字节进行 CRC16 校验 [2] | 2 |

[1] CRC8 生成多项式：0x39，初始值 0x66，无异或和逆运算。
[2] CRC16 生成多项式：0x1021，初始值 0x913D，无异或和逆运算，但数组中低字节优先。

### 寻址关系

|地址编号 | 含义 |
|----------------|------------------------------------------------------------------------------|
| 地址编号 | 含义 |
| 0x03 | MC（运动控制器）|
| 0x06 | AP（第一种上位机，X系列适用）|
| 0x07 | AMS |
| 0x08 | TH |
| 0x09 | AP2（第二种上位机，P系列和A系列适用）|
| 0x0E | AHB |
| 0x0F | EXT（可能是外接控制板）|
| 0x12 | AMS lite |
| 0x13 | CTC |

### 短格式头

| 字节数 | 内容 | 占用字节数 |
|-------------|--------------------------------------|----------------|
| 0 | 0x3D | 1 |
| 1 |标志和序列（大于 0x80）| 1 |
| 2 | 数据包总长度 L | 1 |
| 3 | 所有前一个字节的 CRC8 校验 [1] | 1 |
| 4 | 数据包类型 | 1 |
| 5~(L-3) | 数据包内容 | L-7 |
| (L-2)~(L-1) | 所有前一个字节的 CRC16 校验 [2] | 2 |

[1] CRC8 生成多项式：0x39，初始值 0x66，无异或和逆运算。<br>
[2] CRC16 生成多项式：0x1021，初始值 0x913D，无异或和逆运算，但数组中低字节优先。<br>

短帧头的数据类型（在 AMS Lite 中收集，因此列出的内容适用于 AMS Lite）：
| 值 | （可能的）含义 |
|-------|-----------------------------------------------|
| 0x03 | 读取耗材运动信息 |
| 0x04 | 读取并更改 AMS 灯的运动状态 |
| 0x05 | 验证设备是否在线 |
| 0x06 | 未知 |
| 0x07 | 读取 NFC 信息 |
| 0x20 | 打印机心跳包 |

# 工具
## 解析器
- Protoparser.py -> 数据包解析器，最适合 X1 系列数据包
## 模拟器
- AMCU -> 由研究员 40 61 N 编写的 AMS 模拟器
# Bambu Lab X1 专用 G 代码
目前，Bambu 尚未提供关于 X1 系列打印机可使用哪些标准和非标准 G 代码命令的文档。<br>
至于标准命令，Marlin 交叉引用很不错，但请注意，Bambu 并未实现所有标准命令，而且某些已实现的功能与文中所述略有不同。<br>
在 Bambu 发布官方文档之前，本主题将持续更新，以记录这些内容。有些内容是确定的，有些内容可能是猜测/假设，因此使用以下命令需自行承担风险。<br>
如果您知道任何代码或有任何假设，请在下方讨论，我会将其添加到第一条消息中。

### 硬件控制 代码说明
M960 S0 P0 校准激光器和校准头白色 LED 灯灭<br>
M960 S0 P1 校准激光器和校准头白色 LED 灯亮<br>
M960 S1 P0 校准 Y 轴 808nm（红外，仅透过相机可见）激光器（垂直）灭<br>
M960 S1 P1 校准 Y 轴 808nm（红外，仅透过相机可见）激光器（垂直）亮<br>
M960 S2 P0 校准 X 轴 405nm（紫色）激光器（水平）灭<br>
M960 S2 P1 校准 X 轴 405nm（紫色）激光器（水平）亮<br>
M960 S3 P0/1 似乎什么都没有，或者我还没找到它是什么<br>
M960 S4 P0 校准单元白色 LED 灯灭<br>
M960 S4 P1 校准单元白色 LED 亮起<br>
M960 S5 P0 Bambu Lab 工具头徽标灯关闭<br>
M960 S5 P1 Bambu Lab 工具头徽标灯开启<br>
M17 X/Y/Z#.# 设置 X/Y/Z 步进电机电流**<br>
M106 P1 S0-255 部件冷却风扇关闭-全开***<br>
M106 P2 S0-255 辅助风扇关闭-全开***<br>
M106 P3 S0-255 腔体风扇关闭-全开***<br>
M710 A1 S0-255 电机控制 (MC) 板风扇关闭-全开***<br>
M220 S# 将进给速度设置为正常值的百分比（默认值为 100%）。“M220 S166”与 Ludicrous Speed 相同。<br>
M221 两种用法****<br>
M971 控制内置摄像头<br>
M977 S1 P60 描述为“注册第一层扫描”？我不知道这到底是干什么的，我猜是设置了一个标志，让打印机知道在打印完第一层后执行第一层扫描。这才说得通，因为这个命令在 gcode 文件中调用的时间远早于任何实际打印命令（除了校准/清除行）的发送时间。<br>
M620 C# 根据 AMS 索引校准 AMS<br>
M620 R# 根据托盘索引刷新 AMS<br>
M620 P# 根据托盘索引选择 AMS 托盘<br>
M620 S# 根据托盘索引选择 AMS<br>
M621 S# 根据托盘索引将耗材装入 AMS<br>
**使用此命令时务必格外小心，因为如果设置过高，很容易造成硬件损坏！！！<br>
**示例：M17 Z0.4 将 Z 轴步进电机电流设置为 0.4<br>

***示例：M106 P3 S180 将腔体风扇设置为 70%<br>

**** 如果使用 S#（例如 M221 S75），则将流量设置为 #（默认值为 100）。<br>
**** 如果使用 X0/1、Y0/1 或 Z0/1，则禁用或启用该轴的软件限位挡块（例如，M221 X0 Y1 Z1 将禁用 X 轴的软件限位挡块，并在 Y 轴和 Z 轴上启用它们）。<br>

### 其他 显示消息代码
这些命令会在打印机的 LCD 屏幕上显示消息，并触发应用程序/切片器中显示相应的消息。<br>

LCD 显示屏上显示的代码信息<br>
M1002 gcode_claim_action : 0（清除屏幕信息？）<br>
M1002 gcode_claim_action : 1 自动调平热床<br>
M1002 gcode_claim_action : 2 热床预热<br>
M1002 gcode_claim_action : 3 XY 扫描机械模式<br>
M1002 gcode_claim_action : 4 更换耗材<br>
M1002 gcode_claim_action : 5 M400 暂停<br>
M1002 gcode_claim_action : 6 由于耗材耗尽而暂停<br>
M1002 gcode_claim_action : 7 加热端加热<br>
M1002 gcode_claim_action : 8 校准挤出<br>
M1002 gcode_claim_action : 9 扫描热床表面<br>
M1002 gcode_claim_action : 10 检查第一层<br>
M1002 gcode_claim_action : 11 识别打印平台类型<br>
M1002 gcode_claim_action : 12 校准微型激光雷达<br>
M1002 gcode_claim_action : 13 归位工具头<br>
M1002 gcode_claim_action : 14 清洁喷嘴<br>
M1002 gcode_claim_action : 15 检查挤出机温度<br>
M1002 gcode_claim_action : 16 用户暂停<br>
M1002 gcode_claim_action : 17 由于工具头前盖脱落而暂停<br>
M1002 gcode_claim_action : 18 校准微型激光雷达<br>
M1002 gcode_claim_action : 19 校准挤出机流量<br>
M1002 gcode_claim_action : 20 由于喷嘴温度故障而暂停<br>
M1002 gcode_claim_action : 21 由于热床温度故障而暂停<br>
### 软件控制 代码说明
G29.2 S0 禁用热床调平补偿 (ABL)<br>
G29.2 S1 启用热床调平补偿<br>
M205 X#.## Y#.## Z#.## E#.## 将加加速度限值设置为 #.## 毫米/秒<br>
G29.1 Z#.## 将 Z 轴微调值设置为 #（0 为清除）。例如：“G29.1 Z-0.04” 用于纹理 PEI<br>
M900 K#.## 设置压力提前量，也称为 K 值。例如：“M900 K0.023”<br>
M1002 Judge_flag ####### 选择条件命令的标志，例如“M1002 Judge_flag Extrude_cali_flag”<br>
M622 J1 启动条件代码块，如果选定标志为 True 则执行，否则跳至代码块末尾<br>
M622 J0 条件代码块，如果选定标志为 False，则执行，否则跳至代码块末尾<br>
M623 条件代码块结束<br>
M400 暂停 ​​- 有 3 种使用方法*<br>
暂停方法 1 示例/说明：<br>
在 M400 命令中包含 S# 可暂停 # 秒<br>
<br>
M400 S30<br>
G1 Z100<br>
G1 X100 Y100<br>
说明：暂停 30 秒，然后开始向 Z100 方向移动，并移动到 X100 Y100（无论是否已到达 Z100）<br>
<br>
暂停方法 2 示例/说明：<br>
单独使用 M400 可暂停，直至上一个命令完成<br>
<br>
G1 Z100<br>
M400<br>
G1 X100 Y100<br>
说明：暂停直至到达 Z100，然后移动到 X100 Y100<br>
<br>
暂停方法 3示例/说明：<br>
M400 U1 ；暂停等待用户干预<br>
将 U1 与 M400 一起使用时，其行为类似于通过触摸屏（或应用程序）暂停打印机：工具头停在废料槽处，打印机无限期等待手动恢复。<br>
<br>
### 倾斜校正
打印并测量方形校准 STL<br>
<br>
M1005 X##.#Y##.# ；输入打印的校准 STL 中的值<br>
M500 ；保存值<br>
将上述 G 代码添加到“机器启动 G 代码”的最后一行，并且只运行一次，否则每次运行时补偿都会叠加。移除该 G 代码，重新打印方形校准 STL 并验证测量结果。根据需要重复操作。<br>
<br>
可以使用以下 G 代码重置补偿值。<br><br>

M1005 I0 ；重置补偿值<br>
M500 ；保存值<br>

